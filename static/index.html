<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Interior Designer - Nano Banana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Starter Selection Modal */
        .starter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .starter-modal.hidden {
            display: none;
        }
        
        .starter-content {
            text-align: center;
            max-width: 900px;
            padding: 40px;
        }
        
        .starter-content h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .starter-content p {
            font-size: 1.2em;
            margin-bottom: 40px;
            color: #aaa;
        }
        
        .starter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .starter-option {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }
        
        .starter-option:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .starter-option img {
            width: 100%;
            display: block;
        }
        
        .starter-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2em;
        }
        
        /* Left Panel - Chat */
        .left-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            background: #1a1a2e;
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }
        
        .chat-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .chat-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .dr-bubu-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dr-bubu-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }
        
        .dr-bubu-message {
            flex: 1;
            background: #2a2a3e;
            border-radius: 15px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .input-section {
            margin-top: auto;
        }
        
        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #aaa;
        }
        
        .input-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2a2a3e;
            color: #fff;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #555;
            color: #999;
        }
        
        .submit-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .submit-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .share-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: transparent;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-btn:hover {
            background: #667eea;
            color: white;
        }
        
        /* Right Panel - Canvas */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: #0f0f1e;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #mainCanvas, #furnitureCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #333;
        }
        
        #furnitureCanvas {
            cursor: crosshair;
            z-index: 10;
        }
        
        /* Furniture Selector */
        .furniture-selector {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 15px;
            height: 150px;
            overflow: hidden;
        }
        
        .furniture-selector h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
            white-space: nowrap;
        }
        
        .furniture-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .furniture-scroll::-webkit-scrollbar {
            height: 8px;
        }
        
        .furniture-scroll::-webkit-scrollbar-track {
            background: #0f0f1e;
            border-radius: 4px;
        }
        
        .furniture-scroll::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .furniture-item {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            cursor: grab;
            border: 2px solid #333;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .furniture-item:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .furniture-item:active {
            cursor: grabbing;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-content img {
            width: 288px;
            height: 288px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .loading-content p {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* Session Info */
        .session-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #aaa;
        }
        
        /* Debug Preview */
        .debug-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .debug-preview.show {
            display: flex;
        }
        
        .debug-preview img {
            max-width: 90%;
            max-height: 80vh;
            border: 3px solid #667eea;
            border-radius: 10px;
        }
        
        .debug-preview .debug-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .debug-preview button {
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .debug-preview .close-btn {
            background: #FF4444;
            color: white;
        }
        
        .debug-preview .continue-btn {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Starter Selection Modal -->
    <div class="starter-modal" id="starterModal">
        <div class="starter-content">
            <h1>🚀 Space Interior Designer</h1>
            <p>Choose your starting environment</p>
            <div class="starter-grid">
                <div class="starter-option" data-starter="space">
                    <img src="/static/img/space.png" alt="Space">
                    <div class="starter-label">SPACE</div>
                </div>
                <div class="starter-option" data-starter="moon">
                    <img src="/static/img/moon.png" alt="Moon">
                    <div class="starter-label">MOON</div>
                </div>
                <div class="starter-option" data-starter="mars">
                    <img src="/static/img/mars.png" alt="Mars">
                    <div class="starter-label">MARS</div>
                </div>
                <div class="starter-option" data-starter="ship">
                    <img src="/static/img/ship.png" alt="Ship">
                    <div class="starter-label">SHIP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="chat-header">
                <h2>Dr. Bubu</h2>
            </div>
            
            <div class="dr-bubu-container">
                <img src="/static/img/dr_bubu.png" alt="Dr. Bubu" class="dr-bubu-avatar">
                <div class="dr-bubu-message" id="drBubuMessage">
                    Welcome! Select a starting environment to begin your space interior design journey.
                </div>
            </div>
            
            <div class="input-section">
                <label for="userInput">Your Design Request:</label>
                <textarea id="userInput" placeholder="Describe what you want to add or change..."></textarea>
                <button class="submit-btn" id="submitBtn">Submit</button>
                
                <div class="share-section">
                    <button class="share-btn" id="shareBtn">📤 Share Session</button>
                </div>
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="right-panel">
            <div class="canvas-container">
                <div class="session-info" id="sessionInfo">Session: Loading...</div>
                <canvas id="mainCanvas" width="1184" height="864"></canvas>
                <canvas id="furnitureCanvas" width="1184" height="864"></canvas>
            </div>
            
            <div class="furniture-selector">
                <h3>🪑 Furniture & Items - Drag & Drop</h3>
                <div class="furniture-scroll" id="furnitureScroll">
                    <!-- Furniture items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <img src="/static/img/construction.png" alt="Construction">
            <p>Generating... Please wait</p>
        </div>
    </div>

    <!-- Debug Preview -->
    <div class="debug-preview" id="debugPreview">
        <img id="debugImage" src="" alt="Debug Preview">
        <div class="debug-controls">
            <button class="close-btn" onclick="closeDebugPreview()">Close (Cancel)</button>
            <button class="continue-btn" onclick="continueFromDebug()">Continue to API</button>
        </div>
    </div>

    <script>
        // Debug flag
        const DEBUG = true;
        
        // Global state
        let sessionId = null;
        let history = [];
        let furniturePlacements = [];
        let isDirty = false;
        let selectedFurniture = null;
        
        // Canvas elements
        const mainCanvas = document.getElementById('mainCanvas');
        const furnitureCanvas = document.getElementById('furnitureCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const furnitureCtx = furnitureCanvas.getContext('2d');
        
        // UI elements
        const starterModal = document.getElementById('starterModal');
        const drBubuMessage = document.getElementById('drBubuMessage');
        const userInput = document.getElementById('userInput');
        const submitBtn = document.getElementById('submitBtn');
        const shareBtn = document.getElementById('shareBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const sessionInfo = document.getElementById('sessionInfo');
        const furnitureScroll = document.getElementById('furnitureScroll');
        const debugPreview = document.getElementById('debugPreview');
        const debugImage = document.getElementById('debugImage');
        
        // Debug state
        let debugBlob = null;
        let debugPrompt = null;
        
        // Initialize
        function init() {
            // Generate session ID
            sessionId = generateSessionId();
            sessionInfo.textContent = `Session: ${sessionId}`;
            
            // Load furniture items
            loadFurnitureItems();
            
            // Setup event listeners
            setupEventListeners();
        }
        
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function loadFurnitureItems() {
            for (let i = 1; i <= 20; i++) {
                const img = document.createElement('img');
                img.src = `/static/img/item${i}.png`;
                img.className = 'furniture-item';
                img.dataset.itemId = `item${i}`;
                img.draggable = true;
                
                img.addEventListener('dragstart', (e) => {
                    selectedFurniture = {
                        id: e.target.dataset.itemId,
                        src: e.target.src
                    };
                });
                
                furnitureScroll.appendChild(img);
            }
        }
        
        function setupEventListeners() {
            // Starter selection
            document.querySelectorAll('.starter-option').forEach(option => {
                option.addEventListener('click', () => {
                    const starter = option.dataset.starter;
                    selectStarter(starter);
                });
            });
            
            // Text input change
            userInput.addEventListener('input', () => {
                updateSubmitButton();
            });
            
            // Submit button
            submitBtn.addEventListener('click', handleSubmit);
            
            // Share button
            shareBtn.addEventListener('click', handleShare);
            
            // Furniture canvas drag and drop
            furnitureCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            furnitureCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                if (selectedFurniture) {
                    const rect = furnitureCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    addFurniturePlacement(selectedFurniture, x, y);
                    selectedFurniture = null;
                }
            });
        }
        
        function selectStarter(starter) {
            const imgPath = `/static/img/${starter}.png`;
            const img = new Image();
            img.onload = () => {
                mainCtx.drawImage(img, 0, 0, 1184, 864);
                history.push(imgPath);
                starterModal.classList.add('hidden');
                dr_talk("Great choice! Now you can add furniture by dragging items onto the canvas, or describe your vision in the text box below.");
            };
            img.src = imgPath;
        }
        
        function addFurniturePlacement(furniture, x, y) {
            // 最多只能放 6 個 furniture
            if (furniturePlacements.length >= 6) {
                dr_talk("Maximum 6 furniture items allowed at once!");
                return;
            }
            
            furniturePlacements.push({
                id: furniture.id,
                src: furniture.src,
                x: x,
                y: y
            });
            
            isDirty = true;
            updateSubmitButton();
            drawFurniturePlacements();
        }
        
        function drawFurniturePlacements() {
            furnitureCtx.clearRect(0, 0, 1184, 864);
            
            furniturePlacements.forEach(placement => {
                // Draw circle at placement point
                furnitureCtx.strokeStyle = '#FF0000';
                furnitureCtx.lineWidth = 3;
                furnitureCtx.fillStyle = '#FF0000';
                
                furnitureCtx.beginPath();
                furnitureCtx.arc(placement.x, placement.y, 8, 0, Math.PI * 2);
                furnitureCtx.fill();
                
                // Draw label
                furnitureCtx.fillStyle = '#FFFFFF';
                furnitureCtx.font = '14px Arial';
                furnitureCtx.strokeStyle = '#000000';
                furnitureCtx.lineWidth = 3;
                furnitureCtx.strokeText(placement.id, placement.x + 10, placement.y - 10);
                furnitureCtx.fillText(placement.id, placement.x + 10, placement.y - 10);
            });
        }
        
        function updateSubmitButton() {
            const hasText = userInput.value.trim().length > 0;
            const hasFurniture = furniturePlacements.length > 0;
            
            if (hasText || hasFurniture) {
                submitBtn.classList.add('active');
                isDirty = true;
            } else {
                submitBtn.classList.remove('active');
                isDirty = false;
            }
        }
        
        async function handleSubmit() {
            if (!isDirty || submitBtn.disabled) return;
            
            const prompt = userInput.value.trim();
            if (!prompt && furniturePlacements.length === 0) {
                dr_talk("Please add furniture or describe what you want!");
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.classList.remove('active');
            
            // Show loading overlay
            loadingOverlay.classList.add('show');
            
            try {
                const furnitureCount = furniturePlacements.length;
                
                // 一律使用 1760x864 (左右各 288px 空白)
                const canvasWidth = 1760;
                const canvasHeight = 864;
                const baseImageX = 288; // 底圖固定在中間 (x=288)
                
                // Create composite canvas
                const compositeCanvas = document.createElement('canvas');
                compositeCanvas.width = canvasWidth;
                compositeCanvas.height = canvasHeight;
                const compositeCtx = compositeCanvas.getContext('2d');
                
                // 填充白色背景
                compositeCtx.fillStyle = '#FFFFFF';
                compositeCtx.fillRect(0, 0, canvasWidth, canvasHeight);
                
                // 載入並繪製底圖（history 最後一張）
                if (history.length > 0) {
                    const baseImg = new Image();
                    await new Promise((resolve, reject) => {
                        baseImg.onload = resolve;
                        baseImg.onerror = reject;
                        baseImg.src = history[history.length - 1];
                    });
                    compositeCtx.drawImage(baseImg, baseImageX, 0, 1184, 864);
                }
                
                // 繪製 furniture items
                if (furnitureCount > 0) {
                    // 載入所有 furniture 圖片
                    const furnitureImages = await Promise.all(
                        furniturePlacements.map(placement => {
                            return new Promise((resolve, reject) => {
                                const img = new Image();
                                img.onload = () => resolve({ img, placement });
                                img.onerror = reject;
                                img.src = placement.src;
                            });
                        })
                    );
                    
                    // 決定左右分配：1-3個放左邊，4-6個放右邊
                    const leftCount = Math.min(furnitureCount, 3);
                    const rightCount = Math.max(0, furnitureCount - 3);
                    
                    // 繪製左側 furniture (最多 3 個)
                    for (let i = 0; i < leftCount; i++) {
                        const item = furnitureImages[i];
                        const y = i * 288;
                        
                        // 繪製 furniture 圖片 (288x288)
                        compositeCtx.drawImage(item.img, 0, y, 288, 288);
                        
                        // 繪製箭頭：從 furniture 中心到目標坐標
                        const furnitureCenterX = 144;
                        const furnitureCenterY = y + 144;
                        const targetX = baseImageX + item.placement.x;
                        const targetY = item.placement.y;
                        
                        // 畫線
                        compositeCtx.strokeStyle = '#FF0000';
                        compositeCtx.lineWidth = 3;
                        compositeCtx.beginPath();
                        compositeCtx.moveTo(furnitureCenterX, furnitureCenterY);
                        compositeCtx.lineTo(targetX, targetY);
                        compositeCtx.stroke();
                        
                        // 畫箭頭
                        const angle = Math.atan2(targetY - furnitureCenterY, targetX - furnitureCenterX);
                        const arrowSize = 15;
                        compositeCtx.fillStyle = '#FF0000';
                        compositeCtx.beginPath();
                        compositeCtx.moveTo(targetX, targetY);
                        compositeCtx.lineTo(
                            targetX - arrowSize * Math.cos(angle - Math.PI / 6),
                            targetY - arrowSize * Math.sin(angle - Math.PI / 6)
                        );
                        compositeCtx.lineTo(
                            targetX - arrowSize * Math.cos(angle + Math.PI / 6),
                            targetY - arrowSize * Math.sin(angle + Math.PI / 6)
                        );
                        compositeCtx.closePath();
                        compositeCtx.fill();
                    }
                    
                    // 繪製右側 furniture (第 4-6 個)
                    for (let i = 0; i < rightCount; i++) {
                        const item = furnitureImages[3 + i];
                        const x = 1472; // 1184 + 288
                        const y = i * 288;
                        
                        // 繪製 furniture 圖片 (288x288)
                        compositeCtx.drawImage(item.img, x, y, 288, 288);
                        
                        // 繪製箭頭：從 furniture 中心到目標坐標
                        const furnitureCenterX = x + 144;
                        const furnitureCenterY = y + 144;
                        const targetX = baseImageX + item.placement.x;
                        const targetY = item.placement.y;
                        
                        // 畫線
                        compositeCtx.strokeStyle = '#FF0000';
                        compositeCtx.lineWidth = 3;
                        compositeCtx.beginPath();
                        compositeCtx.moveTo(furnitureCenterX, furnitureCenterY);
                        compositeCtx.lineTo(targetX, targetY);
                        compositeCtx.stroke();
                        
                        // 畫箭頭
                        const angle = Math.atan2(targetY - furnitureCenterY, targetX - furnitureCenterX);
                        const arrowSize = 15;
                        compositeCtx.fillStyle = '#FF0000';
                        compositeCtx.beginPath();
                        compositeCtx.moveTo(targetX, targetY);
                        compositeCtx.lineTo(
                            targetX - arrowSize * Math.cos(angle - Math.PI / 6),
                            targetY - arrowSize * Math.sin(angle - Math.PI / 6)
                        );
                        compositeCtx.lineTo(
                            targetX - arrowSize * Math.cos(angle + Math.PI / 6),
                            targetY - arrowSize * Math.sin(angle + Math.PI / 6)
                        );
                        compositeCtx.closePath();
                        compositeCtx.fill();
                    }
                }
                
                // Convert to blob
                const blob = await new Promise(resolve => compositeCanvas.toBlob(resolve, 'image/png'));
                
                // Build prompt
                let fullPrompt = prompt;
                
                
                if (furniturePlacements.length > 0) {
                    fullPrompt += '這是一張我家的平面圖，旁邊附有家具清單。請將清單上的家具物件精確地移動到平面圖中，並放置在紅線所指示的對應位置上。移動完成後，請刪除所有紅線、家具清單以及左右的空白區域，使圖片只剩下填充家具後的平面圖。';
                    //fullPrompt += 'please move there objects into the image in the center, fellow the red lines. '
                    //fullPrompt += 'after move objects to the place, you can delete the white area, keep only center image. you can made it natural by change the object\' light or direction' ;
                    //fullPrompt += '\n\nFurniture placements: ';
                    // furniturePlacements.forEach(p => {
                    //     fullPrompt += `${p.id} at position (${Math.round(p.x)}, ${Math.round(p.y)}); `;
                    // });
                }
                
                // Debug mode: show preview
                if (DEBUG) {
                    console.log('=== DEBUG MODE ===');
                    console.log('Prompt:', fullPrompt);
                    console.log('Canvas size:', canvasWidth, 'x', canvasHeight);
                    console.log('Furniture count:', furnitureCount);
                    console.log('==================');
                    
                    // Store for later use
                    debugBlob = blob;
                    debugPrompt = fullPrompt;
                    
                    // Show preview
                    const imageUrl = URL.createObjectURL(blob);
                    debugImage.src = imageUrl;
                    debugPreview.classList.add('show');
                    loadingOverlay.classList.remove('show');
                    
                    return; // Stop here in debug mode
                }
                
                // Normal mode: call API directly
                await callAPI(blob, fullPrompt);
                
            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.classList.remove('show');
                dr_talk("Sorry, something went wrong. Please try again.");
                submitBtn.disabled = false;
            }
        }
        
        async function callAPI(blob, fullPrompt) {
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', blob, 'design.png');
                formData.append('prompt', fullPrompt);
                
                // Call API
                const response = await fetch('/api/edit', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.image_urls && data.image_urls.length > 0) {
                    // Load new image
                    const newImg = new Image();
                    newImg.onload = () => {
                        mainCtx.clearRect(0, 0, 1184, 864);
                        mainCtx.drawImage(newImg, 0, 0, 1184, 864);
                        history.push(data.image_urls[0]);
                        
                        // Clear furniture placements
                        furniturePlacements = [];
                        furnitureCtx.clearRect(0, 0, 1184, 864);
                        
                        // Clear input
                        userInput.value = '';
                        isDirty = false;
                        
                        // Hide loading
                        loadingOverlay.classList.remove('show');
                        
                        // Dr. Bubu message
                        dr_talk("Construction complete. Here is your new home!");
                        
                        // Re-enable submit
                        submitBtn.disabled = false;
                    };
                    newImg.src = data.image_urls[0];
                } else {
                    throw new Error(data.message || 'Failed to generate image');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.classList.remove('show');
                dr_talk("Sorry, something went wrong. Please try again.");
                submitBtn.disabled = false;
            }
        }
        
        // Debug control functions
        function closeDebugPreview() {
            debugPreview.classList.remove('show');
            debugBlob = null;
            debugPrompt = null;
            submitBtn.disabled = false;
        }
        
        async function continueFromDebug() {
            if (!debugBlob || !debugPrompt) {
                closeDebugPreview();
                return;
            }
            
            // Hide debug preview and show loading
            debugPreview.classList.remove('show');
            loadingOverlay.classList.add('show');
            
            // Call API with stored data
            await callAPI(debugBlob, debugPrompt);
            
            // Clear debug data
            debugBlob = null;
            debugPrompt = null;
        }
        
        function handleShare() {
            const shareUrl = `${window.location.origin}/?session=${sessionId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                dr_talk(`Session link copied to clipboard! Share this link: ${shareUrl}`);
            }).catch(() => {
                dr_talk(`Share this link: ${shareUrl}`);
            });
        }
        
        // Dr. Bubu talking animation
        function dr_talk(text) {
            drBubuMessage.textContent = '';
            let index = 0;
            
            const interval = setInterval(() => {
                if (index < text.length) {
                    drBubuMessage.textContent += text[index];
                    index++;
                } else {
                    clearInterval(interval);
                }
            }, 30);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
