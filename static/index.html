<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Interior Designer - Nano Banana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Starter Selection Modal */
        .starter-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .starter-modal.hidden {
            display: none;
        }
        
        .starter-content {
            text-align: center;
            max-width: 900px;
            padding: 40px;
        }
        
        .starter-content h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .starter-content p {
            font-size: 1.2em;
            margin-bottom: 40px;
            color: #aaa;
        }
        
        .starter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .starter-option {
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }
        
        .starter-option:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .starter-option img {
            width: 100%;
            display: block;
        }
        
        .starter-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 1.2em;
        }
        
        /* Left Panel - Chat */
        .left-panel {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            background: #1a1a2e;
            border-right: 2px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }
        
        .chat-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .chat-header h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .dr-bubu-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .dr-bubu-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #667eea;
            flex-shrink: 0;
        }
        
        .dr-bubu-message {
            flex: 1;
            background: #2a2a3e;
            border-radius: 15px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .input-section {
            margin-top: auto;
        }
        
        .example-prompts {
            margin-bottom: 15px;
        }
        
        .example-prompts h4 {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .prompt-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .prompt-chip {
            background: #2a2a3e;
            border: 1px solid #444;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.85em;
            color: #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .prompt-chip:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #aaa;
        }
        
        .input-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #2a2a3e;
            color: #fff;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #555;
            color: #999;
        }
        
        .submit-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .submit-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .share-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
        }
        
        .share-btn {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: transparent;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .share-btn:hover {
            background: #667eea;
            color: white;
        }
        
        /* Right Panel - Canvas */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            background: #0f0f1e;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #mainCanvas, #furnitureCanvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid #333;
        }
        
        #furnitureCanvas {
            cursor: crosshair;
            z-index: 10;
        }
        
        /* Furniture Selector */
        .furniture-selector {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 15px;
            height: 150px;
            overflow: hidden;
        }
        
        .furniture-selector h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
            white-space: nowrap;
        }
        
        .furniture-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .furniture-scroll::-webkit-scrollbar {
            height: 8px;
        }
        
        .furniture-scroll::-webkit-scrollbar-track {
            background: #0f0f1e;
            border-radius: 4px;
        }
        
        .furniture-scroll::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .furniture-item {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            cursor: grab;
            border: 2px solid #333;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .furniture-item:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .furniture-item:active {
            cursor: grabbing;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-content img {
            width: 288px;
            height: 288px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .loading-content p {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* Session Info */
        .session-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #aaa;
        }
        
        /* Debug Preview */
        .debug-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .debug-preview.show {
            display: flex;
        }
        
        .debug-preview img {
            max-width: 90%;
            max-height: 80vh;
            border: 3px solid #667eea;
            border-radius: 10px;
        }
        
        .debug-preview .debug-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        .debug-preview button {
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .debug-preview .close-btn {
            background: #FF4444;
            color: white;
        }
        
        .debug-preview .continue-btn {
            background: #667eea;
            color: white;
        }
        
        /* Share Overlay */
        .share-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .share-overlay.show {
            display: flex;
        }
        
        .share-modal {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .share-modal .close-x {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            color: #aaa;
            font-size: 24px;
            line-height: 30px;
            text-align: center;
            transition: color 0.3s;
        }
        
        .share-modal .close-x:hover {
            color: #fff;
        }
        
        .share-modal h2 {
            font-size: 1.8em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .share-modal p {
            color: #ddd;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .share-link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .share-link-input {
            flex: 1;
            padding: 12px;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .share-link-input:hover {
            border-color: #667eea;
        }
        
        .copy-btn {
            padding: 12px 24px;
            background: #667eea;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .copy-btn.copied {
            background: #4caf50;
        }
        
        /* Size Selector Popup */
        .size-selector-overlay {
            position: fixed;
            display: none;
            z-index: 1500;
        }
        
        .size-selector-overlay.show {
            display: block;
        }
        
        .size-selector-modal {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 10px;
            padding: 12px;
            width: 240px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
            text-align: center;
            border: 2px solid #667eea;
        }
        
        .size-slider-container {
            margin: 8px 0;
        }
        
        .size-slider-container label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #ddd;
            font-size: 0.9em;
        }
        
        .size-value {
            color: #667eea;
            font-size: 1em;
            font-weight: bold;
        }
        
        .size-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #1a1a2e;
            outline: none;
            -webkit-appearance: none;
            margin: 15px 0;
        }
        
        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }
        
        .size-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.5);
        }
        
        .size-selector-buttons {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        
        .size-selector-buttons button {
            flex: 1;
            padding: 8px 6px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .size-cancel-btn {
            background: #555;
            color: #ddd;
        }
        
        .size-cancel-btn:hover {
            background: #666;
            transform: translateY(-2px);
        }
        
        .size-delete-btn {
            background: #d32f2f;
            color: white;
        }
        
        .size-delete-btn:hover {
            background: #b71c1c;
            transform: translateY(-2px);
        }
        
        .size-confirm-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .size-confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <!-- Starter Selection Modal -->
    <div class="starter-modal" id="starterModal">
        <div class="starter-content">
            <h1>🚀 Space Interior Designer</h1>
            <p>Choose your starting environment</p>
            <div class="starter-grid">
                <div class="starter-option" data-starter="space">
                    <img src="/static/img/space.png" alt="Space">
                    <div class="starter-label">SPACE</div>
                </div>
                <div class="starter-option" data-starter="moon">
                    <img src="/static/img/moon.png" alt="Moon">
                    <div class="starter-label">MOON</div>
                </div>
                <div class="starter-option" data-starter="mars">
                    <img src="/static/img/mars.png" alt="Mars">
                    <div class="starter-label">MARS</div>
                </div>
                <div class="starter-option" data-starter="ship">
                    <img src="/static/img/ship.png" alt="Ship">
                    <div class="starter-label">SHIP</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="chat-header">
                <h2>Dr. Bubu</h2>
            </div>
            
            <div class="dr-bubu-container">
                <img src="/static/img/dr_bubu.png" alt="Dr. Bubu" class="dr-bubu-avatar">
                <div class="dr-bubu-message" id="drBubuMessage">
                    Welcome! Select a starting environment to begin your space interior design journey.
                </div>
            </div>
            
            <div class="input-section">
                <div class="example-prompts">
                    <h4>💡 Example Requests (Click to add):</h4>
                    <div class="prompt-chips">
                        <div class="prompt-chip" onclick="addExamplePrompt('Add some plants on the right side')">🌱 Add plants on the right</div>
                        <div class="prompt-chip" onclick="addExamplePrompt('Make the lighting warmer and more cozy')">💡 Warmer lighting</div>
                        <div class="prompt-chip" onclick="addExamplePrompt('Add a large window showing Earth view')">🌍 Add Earth view window</div>
                        <div class="prompt-chip" onclick="addExamplePrompt('Place a workstation with monitors on the left')">💻 Add workstation</div>
                        <div class="prompt-chip" onclick="addExamplePrompt('Add floating storage modules on the walls')">📦 Floating storage</div>
                    </div>
                </div>
                
                <label for="userInput">Your Design Request:</label>
                <textarea id="userInput" placeholder="Describe what you want to add or change..."></textarea>
                <button class="submit-btn" id="submitBtn">Submit</button>
                
                <div class="share-section">
                    <button class="share-btn" id="shareBtn">📤 Share Session</button>
                </div>
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="right-panel">
            <div class="canvas-container">
                <div class="session-info" id="sessionInfo">Session: Loading...</div>
                <canvas id="mainCanvas" width="1184" height="864"></canvas>
                <canvas id="furnitureCanvas" width="1184" height="864"></canvas>
            </div>
            
            <div class="furniture-selector">
                <h3>🪑 Furniture & Items - Drag & Drop</h3>
                <div class="furniture-scroll" id="furnitureScroll">
                    <!-- Furniture items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <img src="/static/img/construction.png" alt="Construction">
            <p style="font-size: 1.5em; margin-bottom: 15px;">🏗️ Under Construction... Please Wait</p>
            <p style="font-size: 1em; color: #ffeb3b; margin-bottom: 8px;">⚠️ Note: This feature is powered by Google Nano Banana API</p>
            <p style="font-size: 0.95em; color: #ddd; margin-bottom: 8px;">The generated image may not match your expectations. Please try a few times.</p>
            <p style="font-size: 0.95em; color: #ddd;">Please wait 5-10 seconds for the image to be generated.</p>
        </div>
    </div>

    <!-- Debug Preview -->
    <div class="debug-preview" id="debugPreview">
        <img id="debugImage" src="" alt="Debug Preview">
        <div class="debug-controls">
            <button class="close-btn" onclick="closeDebugPreview()">Close (Cancel)</button>
            <button class="continue-btn" onclick="continueFromDebug()">Continue to API</button>
        </div>
    </div>
    
    <!-- Share Overlay -->
    <div class="share-overlay" id="shareOverlay" onclick="closeShareOverlay(event)">
        <div class="share-modal" onclick="event.stopPropagation()">
            <div class="close-x" onclick="closeShareOverlay()">×</div>
            <h2>🔗 Share Your Design</h2>
            <p>This is your share link. You can share it with your friends.<br>Only people with this link can view your designs.</p>
            <div class="share-link-container">
                <a id="shareLinkInput" class="share-link-input" href="" target="_blank"></a>
                <button class="copy-btn" id="copyBtn" onclick="copyShareLink()">Copy</button>
            </div>
        </div>
    </div>
    
    <!-- Size Selector Popup -->
    <div class="size-selector-overlay" id="sizeSelectorOverlay">
        <div class="size-selector-modal">
            <div class="size-slider-container">
                <label>Size: <span class="size-value" id="sizeValue">150</span>px</label>
                <input type="range" min="100" max="250" value="150" class="size-slider" id="sizeSlider">
            </div>
            <div class="size-selector-buttons">
                <button class="size-delete-btn" onclick="deleteFurniture()">Delete</button>
                <button class="size-cancel-btn" onclick="cancelSizeSelection()">Cancel</button>
                <button class="size-confirm-btn" onclick="confirmSizeSelection()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Debug flag - only enable on localhost
        const DEBUG = window.location.hostname === 'localhost' || 
                      window.location.hostname === '127.0.0.1' || 
                      window.location.hostname === '';
        
        // Global state
        let sessionId = '';
        let sessionSecret = '';
        let history = [];
        let furniturePlacements = [];
        let isDirty = false;
        let selectedFurniture = null;
        let currentStarterImage = null;
        let pendingFurniture = null; // 暫存待確認的家具
        let editingFurnitureIndex = -1; // 正在編輯的家具索引
        
        // Canvas elements
        const mainCanvas = document.getElementById('mainCanvas');
        const furnitureCanvas = document.getElementById('furnitureCanvas');
        const mainCtx = mainCanvas.getContext('2d');
        const furnitureCtx = furnitureCanvas.getContext('2d');
        
        // UI elements
        const starterModal = document.getElementById('starterModal');
        const drBubuMessage = document.getElementById('drBubuMessage');
        const userInput = document.getElementById('userInput');
        const submitBtn = document.getElementById('submitBtn');
        const shareBtn = document.getElementById('shareBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const sessionInfo = document.getElementById('sessionInfo');
        const furnitureScroll = document.getElementById('furnitureScroll');
        
        // Debug state
        let debugBlob = null;
        let debugPrompt = null;
        
        // Furniture placement visualization settings
        const FURNITURE_DISPLAY = {
            defaultSize: 150,        // 預設圖片大小
            text: 'move this object here',  // 顯示文字
            arrowLength: 40,         // 箭頭長度
            fontSize: 14,            // 文字大小
            spacing: 5               // 元素之間的間距
        };
        
        // Initialize
        async function init() {
            // Generate session ID and secret from server
            await generateSession();
            
            // Load furniture items
            loadFurnitureItems();
            
            // Setup event listeners
            setupEventListeners();
        }
        
        async function generateSession() {
            try {
                const response = await fetch('/api/session/generate', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    sessionId = data.session_id;
                    sessionSecret = data.secret;
                    sessionInfo.textContent = `Session: ${sessionId}`;
                    console.log('✅ Session generated:', sessionId);
                    console.log('🔒 Secret stored (not displayed)');
                } else {
                    throw new Error('Failed to generate session');
                }
            } catch (error) {
                console.error('Error generating session:', error);
                dr_talk('Failed to generate session. Please refresh the page.');
            }
        }
        
        function loadFurnitureItems() {
            for (let i = 1; i <= 20; i++) {
                const img = document.createElement('img');
                img.src = `/static/img/item${i}.png`;
                img.className = 'furniture-item';
                img.dataset.itemId = `item${i}`;
                img.draggable = true;
                
                img.addEventListener('dragstart', (e) => {
                    selectedFurniture = {
                        id: e.target.dataset.itemId,
                        src: e.target.src
                    };
                });
                
                furnitureScroll.appendChild(img);
            }
        }
        
        function setupEventListeners() {
            // Starter selection
            document.querySelectorAll('.starter-option').forEach(option => {
                option.addEventListener('click', () => {
                    const starter = option.dataset.starter;
                    selectStarter(starter);
                });
            });
            
            // Text input change
            userInput.addEventListener('input', () => {
                updateSubmitButton();
            });
            
            // Submit button
            submitBtn.addEventListener('click', handleSubmit);
            
            // Share button
            shareBtn.addEventListener('click', handleShare);
            
            // Furniture canvas drag and drop
            furnitureCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            furnitureCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                if (selectedFurniture) {
                    const rect = furnitureCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // 直接添加家具，使用預設大小
                    addFurniturePlacement(selectedFurniture, x, y, FURNITURE_DISPLAY.defaultSize);
                    selectedFurniture = null;
                }
            });
            
            // Click on furniture to edit size
            furnitureCanvas.addEventListener('click', (e) => {
                const rect = furnitureCanvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // 檢查是否點擊到家具
                for (let i = furniturePlacements.length - 1; i >= 0; i--) {
                    const placement = furniturePlacements[i];
                    const size = placement.size || FURNITURE_DISPLAY.defaultSize;
                    const halfSize = size / 2;
                    
                    // 檢查點擊位置是否在家具圖片範圍內
                    const isTopQuarter = placement.y < (864 / 4);
                    let imgY;
                    
                    if (isTopQuarter) {
                        imgY = placement.y - FURNITURE_DISPLAY.arrowLength - FURNITURE_DISPLAY.spacing - size - FURNITURE_DISPLAY.spacing;
                    } else {
                        imgY = placement.y - size - FURNITURE_DISPLAY.spacing * 2 - FURNITURE_DISPLAY.fontSize - FURNITURE_DISPLAY.arrowLength;
                    }
                    
                    if (clickX >= placement.x - halfSize && clickX <= placement.x + halfSize &&
                        clickY >= imgY && clickY <= imgY + size) {
                        // 點擊到家具，顯示尺寸選擇器
                        editingFurnitureIndex = i;
                        const furniture = {
                            id: placement.id,
                            src: placement.src
                        };
                        showSizeSelector(furniture, placement.x, placement.y, e.clientX, e.clientY, placement.size);
                        return;
                    }
                }
                
                // 點擊其他地方，關閉 popup
                if (document.getElementById('sizeSelectorOverlay').classList.contains('show')) {
                    cancelSizeSelection();
                }
            });
            
            // Size slider event
            const sizeSlider = document.getElementById('sizeSlider');
            const sizeValue = document.getElementById('sizeValue');
            
            sizeSlider.addEventListener('input', (e) => {
                const size = e.target.value;
                sizeValue.textContent = size;
                
                // 即時更新正在編輯的家具大小預覽
                if (editingFurnitureIndex >= 0) {
                    const tempSize = parseInt(size);
                    furniturePlacements[editingFurnitureIndex].tempSize = tempSize;
                    drawFurniturePlacements();
                }
            });
        }
        
        function selectStarter(starter) {
            const imgPath = `/static/img/${starter}.png`;
            const img = new Image();
            img.onload = () => {
                mainCtx.drawImage(img, 0, 0, 1184, 864);
                history.push(imgPath);
                starterModal.classList.add('hidden');
                dr_talk("Hello! I'm Dr. Bubu, your design assistant. You can tell me your requirements in text, or let me know how you want to arrange the furniture. I'm here to help you modify your space!");
            };
            img.src = imgPath;
        }
        
        function showSizeSelector(furniture, x, y, screenX, screenY, currentSize = null) {
            // 儲存待確認的家具資訊
            pendingFurniture = {
                furniture: furniture,
                x: x,
                y: y
            };
            
            // 設置 slider
            const sizeSlider = document.getElementById('sizeSlider');
            const sizeValue = document.getElementById('sizeValue');
            const overlay = document.getElementById('sizeSelectorOverlay');
            
            const initialSize = currentSize || FURNITURE_DISPLAY.defaultSize;
            sizeSlider.value = initialSize;
            sizeValue.textContent = initialSize;
            
            // 計算 popup 位置（顯示在點擊位置下方）
            const popupWidth = 240;
            const popupHeight = 120;
            let left = screenX - popupWidth / 2;
            let top = screenY + 20;
            
            // 確保不超出視窗邊界
            if (left < 10) left = 10;
            if (left + popupWidth > window.innerWidth - 10) left = window.innerWidth - popupWidth - 10;
            if (top + popupHeight > window.innerHeight - 10) top = screenY - popupHeight - 20;
            
            overlay.style.left = left + 'px';
            overlay.style.top = top + 'px';
            
            // 顯示 overlay
            overlay.classList.add('show');
        }
        
        function cancelSizeSelection() {
            // 如果正在編輯，恢復原始大小
            if (editingFurnitureIndex >= 0) {
                delete furniturePlacements[editingFurnitureIndex].tempSize;
                drawFurniturePlacements();
            }
            
            pendingFurniture = null;
            editingFurnitureIndex = -1;
            document.getElementById('sizeSelectorOverlay').classList.remove('show');
        }
        
        function confirmSizeSelection() {
            if (!pendingFurniture && editingFurnitureIndex === -1) return;
            
            const size = parseInt(document.getElementById('sizeSlider').value);
            
            if (editingFurnitureIndex >= 0) {
                // 編輯現有家具
                furniturePlacements[editingFurnitureIndex].size = size;
                delete furniturePlacements[editingFurnitureIndex].tempSize;
                editingFurnitureIndex = -1;
            }
            
            isDirty = true;
            updateSubmitButton();
            drawFurniturePlacements();
            
            // 關閉 overlay
            pendingFurniture = null;
            document.getElementById('sizeSelectorOverlay').classList.remove('show');
        }
        
        function deleteFurniture() {
            if (editingFurnitureIndex >= 0) {
                // 刪除家具
                furniturePlacements.splice(editingFurnitureIndex, 1);
                editingFurnitureIndex = -1;
                
                isDirty = furniturePlacements.length > 0 || userInput.value.trim().length > 0;
                updateSubmitButton();
                drawFurniturePlacements();
                
                // 關閉 overlay
                pendingFurniture = null;
                document.getElementById('sizeSelectorOverlay').classList.remove('show');
            }
        }
        
        function addFurniturePlacement(furniture, x, y, size = FURNITURE_DISPLAY.defaultSize) {
            // 最多只能放 4 個 furniture
            if (furniturePlacements.length >= 4) {
                dr_talk("Maximum 4 furniture items allowed at once!");
                return;
            }
            
            furniturePlacements.push({
                id: furniture.id,
                src: furniture.src,
                x: x,
                y: y,
                size: size
            });
            
            isDirty = true;
            updateSubmitButton();
            drawFurniturePlacements();
        }
        
        function drawFurniturePlacements() {
            furnitureCtx.clearRect(0, 0, 1184, 864);
            
            furniturePlacements.forEach(placement => {
                // 使用 tempSize（拖動時的臨時大小）或正式的 size
                const itemSize = placement.tempSize || placement.size || FURNITURE_DISPLAY.defaultSize;
                const text = FURNITURE_DISPLAY.text;
                const arrowLength = FURNITURE_DISPLAY.arrowLength;
                const fontSize = FURNITURE_DISPLAY.fontSize;
                const spacing = FURNITURE_DISPLAY.spacing;
                
                // 判斷是否在上方 1/4
                const isTopQuarter = placement.y < (864 / 4);
                
                // 載入並繪製 item 圖片
                const img = new Image();
                img.src = placement.src;
                
                if (isTopQuarter) {
                    // 上方 1/4: 箭頭 -> 圖片 -> 文字 (由上往下)
                    let currentY = placement.y - arrowLength - spacing;
                    
                    // 1. 繪製箭頭 (指向 placement.y)
                    furnitureCtx.fillStyle = '#FF0000';
                    furnitureCtx.strokeStyle = '#FF0000';
                    furnitureCtx.lineWidth = 2;
                    
                    // 箭頭線
                    furnitureCtx.beginPath();
                    furnitureCtx.moveTo(placement.x, currentY);
                    furnitureCtx.lineTo(placement.x, placement.y);
                    furnitureCtx.stroke();
                    
                    // 箭頭頭部
                    furnitureCtx.beginPath();
                    furnitureCtx.moveTo(placement.x, placement.y);
                    furnitureCtx.lineTo(placement.x - 8, placement.y - 12);
                    furnitureCtx.lineTo(placement.x + 8, placement.y - 12);
                    furnitureCtx.closePath();
                    furnitureCtx.fill();
                    
                    // 2. 繪製圖片 (在箭頭上方)
                    currentY = currentY - itemSize - spacing;
                    if (img.complete) {
                        furnitureCtx.drawImage(img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                    } else {
                        img.onload = () => {
                            furnitureCtx.drawImage(img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                        };
                    }
                    
                    // 3. 繪製文字 (在圖片上方)
                    furnitureCtx.font = `${fontSize}px Arial`;
                    furnitureCtx.fillStyle = '#FFFFFF';
                    furnitureCtx.strokeStyle = '#000000';
                    furnitureCtx.lineWidth = 3;
                    const textWidth = furnitureCtx.measureText(text).width;
                    const textX = placement.x - textWidth / 2;
                    const textY = currentY - spacing;
                    furnitureCtx.strokeText(text, textX, textY);
                    furnitureCtx.fillText(text, textX, textY);
                    
                } else {
                    // 其他位置: 圖片 -> 文字 -> 箭頭 (由上往下)
                    let currentY = placement.y - itemSize - spacing * 2 - fontSize - arrowLength;
                    
                    // 1. 繪製圖片
                    if (img.complete) {
                        furnitureCtx.drawImage(img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                    } else {
                        img.onload = () => {
                            furnitureCtx.drawImage(img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                        };
                    }
                    
                    // 2. 繪製文字 (在圖片下方)
                    currentY += itemSize + spacing + fontSize;
                    furnitureCtx.font = `${fontSize}px Arial`;
                    furnitureCtx.fillStyle = '#FFFFFF';
                    furnitureCtx.strokeStyle = '#000000';
                    furnitureCtx.lineWidth = 3;
                    const textWidth = furnitureCtx.measureText(text).width;
                    const textX = placement.x - textWidth / 2;
                    furnitureCtx.strokeText(text, textX, currentY);
                    furnitureCtx.fillText(text, textX, currentY);
                    
                    // 3. 繪製箭頭 (在文字下方，指向 placement.y)
                    currentY += spacing;
                    furnitureCtx.fillStyle = '#FF0000';
                    furnitureCtx.strokeStyle = '#FF0000';
                    furnitureCtx.lineWidth = 2;
                    
                    // 箭頭線
                    furnitureCtx.beginPath();
                    furnitureCtx.moveTo(placement.x, currentY);
                    furnitureCtx.lineTo(placement.x, placement.y);
                    furnitureCtx.stroke();
                    
                    // 箭頭頭部
                    furnitureCtx.beginPath();
                    furnitureCtx.moveTo(placement.x, placement.y);
                    furnitureCtx.lineTo(placement.x - 8, placement.y - 12);
                    furnitureCtx.lineTo(placement.x + 8, placement.y - 12);
                    furnitureCtx.closePath();
                    furnitureCtx.fill();
                }
                
                // 繪製目標點
                furnitureCtx.fillStyle = '#FF0000';
                furnitureCtx.beginPath();
                furnitureCtx.arc(placement.x, placement.y, 5, 0, Math.PI * 2);
                furnitureCtx.fill();
            });
        }
        
        function updateSubmitButton() {
            const hasText = userInput.value.trim().length > 0;
            const hasFurniture = furniturePlacements.length > 0;
            
            if (hasText || hasFurniture) {
                submitBtn.classList.add('active');
                isDirty = true;
            } else {
                submitBtn.classList.remove('active');
                isDirty = false;
            }
        }
        
        async function handleSubmit() {
            if (!isDirty || submitBtn.disabled) return;
            
            const prompt = userInput.value.trim();
            if (!prompt && furniturePlacements.length === 0) {
                dr_talk("Please add furniture or describe what you want!");
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.classList.remove('active');
            
            // Show loading overlay
            loadingOverlay.classList.add('show');
            
            try {
                const furnitureCount = furniturePlacements.length;
                
                // 不加空白，直接使用 1184x864
                const canvasWidth = 1184;
                const canvasHeight = 864;
                const baseImageX = 0; // 底圖從 x=0 開始
                
                // Create composite canvas
                const compositeCanvas = document.createElement('canvas');
                compositeCanvas.width = canvasWidth;
                compositeCanvas.height = canvasHeight;
                const compositeCtx = compositeCanvas.getContext('2d');
                
                // 載入並繪製底圖（history 最後一張）
                if (history.length > 0) {
                    const baseImg = new Image();
                    await new Promise((resolve, reject) => {
                        baseImg.onload = resolve;
                        baseImg.onerror = reject;
                        baseImg.src = history[history.length - 1];
                    });
                    compositeCtx.drawImage(baseImg, 0, 0, 1184, 864);
                }
                
                // 繪製 furniture items (與 drawFurniturePlacements 相同的邏輯)
                if (furnitureCount > 0) {
                    // 載入所有 furniture 圖片
                    const furnitureImages = await Promise.all(
                        furniturePlacements.map(placement => {
                            return new Promise((resolve, reject) => {
                                const img = new Image();
                                img.onload = () => resolve({ img, placement });
                                img.onerror = reject;
                                img.src = placement.src;
                            });
                        })
                    );
                    
                    // 繪製每個 furniture placement
                    for (let i = 0; i < furnitureCount; i++) {
                        const item = furnitureImages[i];
                        const placement = item.placement;
                        
                        const itemSize = placement.size || FURNITURE_DISPLAY.defaultSize;
                        const text = FURNITURE_DISPLAY.text;
                        const arrowLength = FURNITURE_DISPLAY.arrowLength;
                        const fontSize = FURNITURE_DISPLAY.fontSize;
                        const spacing = FURNITURE_DISPLAY.spacing;
                        
                        // 判斷是否在上方 1/4
                        const isTopQuarter = placement.y < (864 / 4);
                        
                        if (isTopQuarter) {
                            // 上方 1/4: 箭頭 -> 圖片 -> 文字 (由上往下)
                            let currentY = placement.y - arrowLength - spacing;
                            
                            // 1. 繪製箭頭 (指向 placement.y)
                            compositeCtx.fillStyle = '#FF0000';
                            compositeCtx.strokeStyle = '#FF0000';
                            compositeCtx.lineWidth = 2;
                            
                            // 箭頭線
                            compositeCtx.beginPath();
                            compositeCtx.moveTo(placement.x, currentY);
                            compositeCtx.lineTo(placement.x, placement.y);
                            compositeCtx.stroke();
                            
                            // 箭頭頭部
                            compositeCtx.beginPath();
                            compositeCtx.moveTo(placement.x, placement.y);
                            compositeCtx.lineTo(placement.x - 8, placement.y - 12);
                            compositeCtx.lineTo(placement.x + 8, placement.y - 12);
                            compositeCtx.closePath();
                            compositeCtx.fill();
                            
                            // 2. 繪製圖片 (在箭頭上方)
                            currentY = currentY - itemSize - spacing;
                            compositeCtx.drawImage(item.img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                            
                            // 3. 繪製文字 (在圖片上方)
                            compositeCtx.font = `${fontSize}px Arial`;
                            compositeCtx.fillStyle = '#FFFFFF';
                            compositeCtx.strokeStyle = '#000000';
                            compositeCtx.lineWidth = 3;
                            const textWidth = compositeCtx.measureText(text).width;
                            const textX = placement.x - textWidth / 2;
                            const textY = currentY - spacing;
                            compositeCtx.strokeText(text, textX, textY);
                            compositeCtx.fillText(text, textX, textY);
                            
                        } else {
                            // 其他位置: 圖片 -> 文字 -> 箭頭 (由上往下)
                            let currentY = placement.y - itemSize - spacing * 2 - fontSize - arrowLength;
                            
                            // 1. 繪製圖片
                            compositeCtx.drawImage(item.img, placement.x - itemSize/2, currentY, itemSize, itemSize);
                            
                            // 2. 繪製文字 (在圖片下方)
                            currentY += itemSize + spacing + fontSize;
                            compositeCtx.font = `${fontSize}px Arial`;
                            compositeCtx.fillStyle = '#FFFFFF';
                            compositeCtx.strokeStyle = '#000000';
                            compositeCtx.lineWidth = 3;
                            const textWidth = compositeCtx.measureText(text).width;
                            const textX = placement.x - textWidth / 2;
                            compositeCtx.strokeText(text, textX, currentY);
                            compositeCtx.fillText(text, textX, currentY);
                            
                            // 3. 繪製箭頭 (在文字下方，指向 placement.y)
                            currentY += spacing;
                            compositeCtx.fillStyle = '#FF0000';
                            compositeCtx.strokeStyle = '#FF0000';
                            compositeCtx.lineWidth = 2;
                            
                            // 箭頭線
                            compositeCtx.beginPath();
                            compositeCtx.moveTo(placement.x, currentY);
                            compositeCtx.lineTo(placement.x, placement.y);
                            compositeCtx.stroke();
                            
                            // 箭頭頭部
                            compositeCtx.beginPath();
                            compositeCtx.moveTo(placement.x, placement.y);
                            compositeCtx.lineTo(placement.x - 8, placement.y - 12);
                            compositeCtx.lineTo(placement.x + 8, placement.y - 12);
                            compositeCtx.closePath();
                            compositeCtx.fill();
                        }
                        
                        // 繪製目標點
                        compositeCtx.fillStyle = '#FF0000';
                        compositeCtx.beginPath();
                        compositeCtx.arc(placement.x, placement.y, 5, 0, Math.PI * 2);
                        compositeCtx.fill();
                    }
                }
                
                // Convert to blob
                const blob = await new Promise(resolve => compositeCanvas.toBlob(resolve, 'image/png'));
                
                // Build prompt
                let fullPrompt = "Creatively reimagine and enhance the image(s). ";
                fullPrompt += prompt ;
                fullPrompt += " \n" ;
                
                
                if (furniturePlacements.length > 0) {
                    fullPrompt = 'You are doing interior design. '
                    fullPrompt += 'please move there objects into the image in the center, fellow the red lines. '
                    fullPrompt += 'Carefully remove the object or area highlighted in semi-transparent red, and realistically fill in the background (inpainting)';
                    fullPrompt += ' In the area highlighted in semi-transparent red, Make it look natural and seamless.';
                    
                    //fullPrompt += 'after move objects to the place, you can delete the white area, keep only center image. you can made it natural by change the object\' light or direction' ;
                    //fullPrompt += '\n\nFurniture placements: ';
                    // furniturePlacements.forEach(p => {
                    //     fullPrompt += `${p.id} at position (${Math.round(p.x)}, ${Math.round(p.y)}); `;
                    // });
                }
                
                // Debug mode: show preview
                if (DEBUG) {
                    console.log('=== DEBUG MODE ===');
                    console.log('Prompt:', fullPrompt);
                    console.log('Canvas size:', canvasWidth, 'x', canvasHeight);
                    console.log('Furniture count:', furnitureCount);
                    console.log('==================');
                    
                    // Store for later use
                    debugBlob = blob;
                    debugPrompt = fullPrompt;
                    
                    // Show preview
                    const imageUrl = URL.createObjectURL(blob);
                    debugImage.src = imageUrl;
                    debugPreview.classList.add('show');
                    loadingOverlay.classList.remove('show');
                    
                    return; // Stop here in debug mode
                }
                
                // Normal mode: call API directly
                await callAPI(blob, fullPrompt);
                
            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.classList.remove('show');
                dr_talk("Sorry, something went wrong. Please try again.");
                submitBtn.disabled = false;
            }
        }
        
        async function callAPI(blob, fullPrompt) {
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', blob, 'design.png');
                formData.append('prompt', fullPrompt);
                formData.append('session_id', sessionId);
                formData.append('secret', sessionSecret);
                
                // Call API
                const response = await fetch('/api/edit', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.image_urls && data.image_urls.length > 0) {
                    // Load new image
                    const newImg = new Image();
                    newImg.onload = () => {
                        mainCtx.clearRect(0, 0, 1184, 864);
                        mainCtx.drawImage(newImg, 0, 0, 1184, 864);
                        history.push(data.image_urls[0]);
                        
                        // Clear furniture placements
                        furniturePlacements = [];
                        furnitureCtx.clearRect(0, 0, 1184, 864);
                        
                        // Clear input
                        userInput.value = '';
                        isDirty = false;
                        
                        // Hide loading
                        loadingOverlay.classList.remove('show');
                        
                        // Dr. Bubu message
                        dr_talk("Construction complete. Here is your new home!");
                        
                        // Re-enable submit
                        submitBtn.disabled = false;
                    };
                    newImg.src = data.image_urls[0];
                } else {
                    throw new Error(data.message || 'Failed to generate image');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingOverlay.classList.remove('show');
                dr_talk("Sorry, something went wrong. Please try again.");
                submitBtn.disabled = false;
            }
        }
        
        // Debug control functions
        function closeDebugPreview() {
            debugPreview.classList.remove('show');
            debugBlob = null;
            debugPrompt = null;
            submitBtn.disabled = false;
        }
        
        async function continueFromDebug() {
            if (!debugBlob || !debugPrompt) {
                closeDebugPreview();
                return;
            }
            
            // Hide debug preview and show loading
            debugPreview.classList.remove('show');
            loadingOverlay.classList.add('show');
            
            // Call API with stored data
            await callAPI(debugBlob, debugPrompt);
            
            // Clear debug data
            debugBlob = null;
            debugPrompt = null;
        }
        
        function handleShare() {
            // 檢查是否有提交過
            if (history.length <= 1) {
                alert('Please submit your design request first!');
                dr_talk('Please submit your design request first before sharing.');
                return;
            }
            
            // 顯示分享 overlay
            const shareUrl = `${window.location.origin}/share/${sessionId}`;
            const shareLinkInput = document.getElementById('shareLinkInput');
            const shareOverlay = document.getElementById('shareOverlay');
            
            shareLinkInput.textContent = shareUrl;
            shareLinkInput.href = shareUrl;
            shareOverlay.classList.add('show');
        }
        
        function closeShareOverlay(event) {
            const shareOverlay = document.getElementById('shareOverlay');
            shareOverlay.classList.remove('show');
        }
        
        function copyShareLink() {
            const shareLinkInput = document.getElementById('shareLinkInput');
            const copyBtn = document.getElementById('copyBtn');
            const shareUrl = shareLinkInput.textContent;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                    copyBtn.classList.remove('copied');
                }, 2000);
                
                dr_talk('Share link copied to clipboard! 🎉');
            }).catch(() => {
                dr_talk('Failed to copy link. Please copy it manually.');
            });
        }
        
        // Add example prompt to textarea
        function addExamplePrompt(promptText) {
            const confirmed = confirm(`Add this request?\n\n"${promptText}"\n\nClick OK to add to your design request.`);
            
            if (confirmed) {
                const currentText = userInput.value.trim();
                if (currentText) {
                    userInput.value = currentText + '\n' + promptText;
                } else {
                    userInput.value = promptText;
                }
                
                // Mark as dirty
                isDirty = true;
                updateSubmitButton();
                
                // Dr. Bubu response
                dr_talk(`Great! I've added "${promptText}" to your request. Feel free to modify it or add more details!`);
            }
        }
        
        // Dr. Bubu talking animation
        function dr_talk(text) {
            drBubuMessage.textContent = '';
            let index = 0;
            
            const interval = setInterval(() => {
                if (index < text.length) {
                    drBubuMessage.textContent += text[index];
                    index++;
                } else {
                    clearInterval(interval);
                }
            }, 30);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>
